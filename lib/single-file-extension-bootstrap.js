!function(){"use strict";const e=globalThis.singlefileBootstrap,t=33554432;let o,a,n,s,d,i,r,c,u;async function l(t){return d&&"content.autosave"==t.method?(async function(e){a=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await v(),a.autoSaveRepeat&&setTimeout((()=>{d&&!r&&(c=!1,a.autoSaveDelay=0,l(e))}),1e3*a.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(m(),{}):"content.init"==t.method?(a=t.options,d=t.autoSaveEnabled,h(),{}):"content.openEditor"==t.method?(b(document)?g(document):h(),{}):"devtools.resourceCommitted"==t.method?(e.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):void 0}function m(){const t=document.querySelector("singlefile-infobar");t&&t.remove(),u==location.href||e.pageInfo.processing||(c=!1,u=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:b(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function v(){const t=e.helper;if((!r||i)&&!c)if(r=!0,a.autoSaveDelay&&!i)await new Promise((e=>i=setTimeout(e,1e3*a.autoSaveDelay))),await v();else{const o=window[t.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let n,s=[];i=null,!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=await e.processors.frameTree.getAsync(a)),n=s&&s.sessionId,a.userScriptEnabled&&o&&await o(t.ON_BEFORE_CAPTURE_EVENT_NAME);const d=t.preProcessDoc(document,globalThis,a);f(d,s),n&&e.processors.frameTree.cleanup(n),t.postProcessDoc(document,d.markedElements,d.invalidElements),a.userScriptEnabled&&o&&await o(t.ON_AFTER_CAPTURE_EVENT_NAME),c=!0,r=!1}}function h(){d&&a&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveDiscard||a.autoSaveRemove)?o||(globalThis.addEventListener("unload",E),document.addEventListener("visibilitychange",p),o=!0):(globalThis.removeEventListener("unload",E),document.removeEventListener("visibilitychange",p),o=!1)}function p(){"hidden"==document.visibilityState&&a.autoSaveDiscard&&S({autoSaveDiscard:a.autoSaveDiscard})}function E(){!c&&(a.autoSaveUnload||a.autoSaveLoadOrUnload||a.autoSaveRemove)&&S({autoSaveUnload:a.autoSaveUnload,autoSaveRemove:a.autoSaveRemove})}function S({autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:n}){const s=e.helper,d=window[s.WAIT_FOR_USERSCRIPT_PROPERTY_NAME];let i=[];!a.removeFrames&&globalThis.frames&&globalThis.frames.length&&(i=e.processors.frameTree.getSync(a)),a.userScriptEnabled&&d&&d(s.ON_BEFORE_CAPTURE_EVENT_NAME);f(s.preProcessDoc(document,globalThis,a),i,{autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:n})}function f(t,o,{autoSaveUnload:d,autoSaveDiscard:i,autoSaveRemove:r}={}){const c=e.helper,u=e.pageInfo.updatedResources,l=e.pageInfo.visitDate.getTime();Object.keys(u).forEach((e=>u[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:n,tabIndex:s,taskId:a.taskId,content:c.serialize(document),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,videos:t.videos,referrer:t.referrer,adoptedStyleSheets:t.adoptedStyleSheets,frames:o,url:location.href,updatedResources:u,visitDate:l,autoSaveUnload:d,autoSaveDiscard:i,autoSaveRemove:r})}async function g(o){R(o);const a=e.helper.serialize(o);for(let e=0;e*t<a.length;e++){const o={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])};o.truncated=a.length>t,o.truncated?(o.finished=(e+1)*t>a.length,o.content=a.substring(e*t,(e+1)*t)):o.content=a,await browser.runtime.sendMessage(o)}}function b(t){const o=e.helper,a=t.documentElement.firstChild;return a.nodeType==Node.COMMENT_NODE&&(a.textContent.includes(o.COMMENT_HEADER)||a.textContent.includes(o.COMMENT_HEADER_LEGACY))}function R(t){t.querySelectorAll("*").forEach((t=>{const o=e.helper.getShadowRoot(t);if(o){R(o);const e=document.createElement("template");e.setAttribute("shadowroot","open"),Array.from(o.childNodes).forEach((t=>e.appendChild(t))),t.appendChild(e)}}))}e.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{a=e.optionsAutoSave;const t=e.options;n=e.tabId,s=e.tabIndex,d=e.autoSaveEnabled,t&&t.autoOpenEditor&&b(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>g(document))):g(document):h()})),browser.runtime.onMessage.addListener((e=>{if(d&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method)return l(e)})),document.addEventListener("DOMContentLoaded",m,!1)}();
